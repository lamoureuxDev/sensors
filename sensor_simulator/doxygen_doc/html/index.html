<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sensor Simulator: README</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="LD_trombone_2.ico"/></td>
  <td id="projectalign">
   <div id="projectname">Sensor Simulator<span id="projectnumber">&#160;V00.00.02</span>
   </div>
   <div id="projectbrief">Display random senor values, setted in a shared memory</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">README </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#sec">Description</a></li>
<li class="level1"><a href="#Installation">Installation</a></li>
<li class="level1"><a href="#Deployment">Deployment</a><ul><li class="level2"><a href="#Linux">Linux</a></li>
<li class="level2"><a href="#Yocto">Yocto</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><ul>
<li>Description</li>
<li>Installation</li>
<li>Deployment<ul>
<li>Linux deployment</li>
<li>Yocto deployment</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="sec"></a>
Description</h1>
<p>The Sensor Simulator program is a UI, designed to set random sensors values in a shared memory. Values are setted every second by default with a different fixed range for each type of sensor.</p>
<p>This program is intended to simulate real sensors, sending data. Use it only for testing purpose, alongside a sensor_alert and/or a sensor_stat to read simulated values.</p>
<p>A shared memory is used to communicate between processes and share sensors data. Sensor_simulator use the shared memory only in writting mode.</p>
<p>Please do not run this program yourself, instead use systemd services with the attached script.</p>
<h1><a class="anchor" id="Installation"></a>
Installation</h1>
<p>This software is based on Qt library and C++17. To install Qt and C++ compilator, please run the following commands on linux: </p><div class="fragment"><div class="line">$ sudo apt-get install build-essential</div>
<div class="line">$ sudo apt-get install qtbase5-dev</div>
</div><!-- fragment --><p>To run the program, please change your current directory to the build path. Then, compile the program with qmake and make as follow: </p><div class="fragment"><div class="line">$ cd /build_path</div>
<div class="line">$ qmake</div>
<div class="line">$ make</div>
<div class="line">$ ./sensor_simulator</div>
</div><!-- fragment --><h1><a class="anchor" id="Deployment"></a>
Deployment</h1>
<h2><a class="anchor" id="Linux"></a>
Linux</h2>
<p>Follow these steps to deploy the sensor_stats on your Linux system:</p><ul>
<li>install prerequisites</li>
<li>build the app</li>
<li>move the execution file to "/usr/bin/"</li>
<li>move the sensors_script.sh file to "/usr/bin/"</li>
<li>add execution right on the script and execution file</li>
<li>create a Unit file on /lib/systemd/system/mysensors.service</li>
<li>add execution right on the Unit file</li>
<li>start the service and check that is running</li>
<li>stop it, then enable it to start on boot.</li>
</ul>
<div class="fragment"><div class="line">$ sudo apt-get install build-essential</div>
<div class="line">$ sudo apt-get install qtbase5-dev</div>
<div class="line">$ sudo cp sensor_stat /usr/bin</div>
<div class="line">$ sudo mv sensors_script.sh /usr/bin</div>
<div class="line">$ sudo chmod +x /usr/bin/sensors_script.sh</div>
<div class="line">$ sudo chmod +x /usr/bin/sensor_simulator</div>
<div class="line">$ sudo gedit /lib/systemd/system/mysensors.service</div>
<div class="line">    [Unit]</div>
<div class="line">     Description= My sensors service running /usr/bin/sensors_script.sh</div>
<div class="line"> </div>
<div class="line">     [Service]</div>
<div class="line">     Type=simple</div>
<div class="line">     ExecStart=/bin/bash /usr/bin/sensors_script.sh</div>
<div class="line"> </div>
<div class="line">     [Install]</div>
<div class="line">     WantedBy=multi-user.target</div>
<div class="line"> </div>
<div class="line">$ sudo cp /lib/systemd/system/mysensors.service /etc/systemd/system/</div>
<div class="line">$ sudo chmod 644 /etc/systemd/system/mysensors.service/</div>
<div class="line">$ sudo systemctl start mysensors</div>
<div class="line">$ sudo systemctl stop mysensors</div>
<div class="line">$ sudo systemctl enable mysensors</div>
</div><!-- fragment --><p>Following theses steps, sensor_simulator program will run automaticaly on boot, along side the sensor_stat and sensor_alerts, with the sensor_simulator launched fisrt.</p>
<h2><a class="anchor" id="Yocto"></a>
Yocto</h2>
<p>Using yocto to build an image and add our services.</p>
<p>First of all, be sure to have prerequisites for yocto:</p><ul>
<li>A linux OS ( Docker, WSL, linux distro partition ..)</li>
<li>100 Gb minimum free space on host disk</li>
<li>a good computer ( RAM &gt; 16 Go, #CPU &gt; 16) or a lot of time</li>
<li>IT network simple and reliable ( no proxy, intrusive firewall, stable connection)</li>
<li>a host updated</li>
</ul>
<p>Fist of all, we will need to download yocto project </p><div class="fragment"><div class="line">$ sudo apt-get install gawk wget git-core diffstat unzip texinfo gcc-multilib \</div>
<div class="line">     build-essential chrpath socat libsdl1.2-dev xterm</div>
<div class="line">$ sudo apt update</div>
<div class="line">$sudo apt autoremove</div>
</div><!-- fragment --><p>When all tools are installed, we can create our environement, creating a folder to download the Yocto Project and checkout the last version, <code>mickledore</code></p>
<div class="fragment"><div class="line">$ mkdir yocto</div>
<div class="line">$ cd yocto</div>
<div class="line">$ git clone http:<span class="comment">//git.yoctoproject.org/git/poky</span></div>
<div class="line">$ cd poky</div>
<div class="line">$ git checkout -b mickledore origin/mickledore</div>
</div><!-- fragment --><p>Here, we will want to build layers, and we will need bitbake tools and others. To get an easy access to them, we will load a special environnement from de open embedded project</p>
<div class="fragment"><div class="line">poky$ source oe-init-build-env</div>
<div class="line"><span class="preprocessor">### Shell environment set up for builds. ###</span></div>
<div class="line"> </div>
<div class="line">You can now run <span class="stringliteral">&#39;bitbake &lt;target&gt;&#39;</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="class_common.html">Common</a> targets are:</div>
<div class="line">    core-image-minimal</div>
<div class="line">    core-image-full-cmdline</div>
<div class="line">    core-image-sato</div>
<div class="line">    core-image-weston</div>
<div class="line">    meta-toolchain</div>
<div class="line">    meta-ide-support</div>
<div class="line"> </div>
<div class="line">Other commonly useful commands are:</div>
<div class="line"> - <span class="stringliteral">&#39;devtool&#39;</span> and <span class="stringliteral">&#39;recipetool&#39;</span> handle common recipe tasks</div>
<div class="line"> - <span class="stringliteral">&#39;bitbake-layers&#39;</span> handles common layer tasks</div>
<div class="line"> - <span class="stringliteral">&#39;oe-pkgdata-util&#39;</span> handles common target <span class="keyword">package </span>tasks</div>
<div class="ttc" id="aclass_common_html"><div class="ttname"><a href="class_common.html">Common</a></div><div class="ttdoc">A Common class to access the sensor shared memory.</div><div class="ttdef"><b>Definition</b> common.h:43</div></div>
</div><!-- fragment --><p>Without any option, this will create a build directory in yocto, and change our current $PWD to poky/build. If we list directories in $poky/, we find many meta-XX folders, they are layers. In every layer, we find one or more recipes. A recipe is a bitbake file (*.bb), wich configure the build process, commands to execute when building the recipe.</p>
<p>Like in the Linux deployment, we will need to install dependencies first of all, before compiling our recipe. To know our depedencies, we have to check <a href="https://layers.openembedded.org">https://layers.openembedded.org</a>. For meta-qt5, we can see <a href="https://github.com/meta-qt5/meta-qt5.git">https://github.com/meta-qt5/meta-qt5.git</a></p>
<p>to add it, we need to download it, then add the layer to our bblayer </p><div class="fragment"><div class="line">poky$ git clone https:<span class="comment">//github.com/meta-qt5/meta-qt5.git</span></div>
<div class="line">poky$ bitbake-layers add-layerr meta-qt5</div>
<div class="line">poky$ bitbake-layers show-layers</div>
<div class="line">layer                 path                                                                    priority</div>
<div class="line">========================================================================================================</div>
<div class="line"> </div>
<div class="line">qt5-layer             /home/lamoureux/yoctoiot/layers/poky/meta-qt5                           7</div>
</div><!-- fragment --><p>we will try step by step to build an image with new layers, see how qt5 layers are built to build our layer</p>
<p>Today, I dont get yet a layer with every depedencies installed, to build my layer without any error using Qt5, but I can compile C++ code, and have my code working but only in console, or loggin in files. Anyway, together and with more than three days on it we will find every layers needed. In order to run my qt application, we could use a pre cross compilation for the target, then copy the binary file in ${bindir}</p>
<p>To populate our recipe for sensor-stats, we will import our source files in our recipe to get this architecture: (assuming that $BUILD_SENSOR_SIMU= /path/to/sensor_stats_sources)</p>
<div class="fragment"><div class="line">../poky/buils$ bitbake-layers create-layer ../meta-sensors</div>
<div class="line">../poky/buils$ cd ../meta-sensors</div>
<div class="line">../poky/meta-sensors$ mv recipes-example recipes-sensor-simu</div>
<div class="line">../poky/meta-sensors$ mkdir recipes-sensor-simu/sensor-simu</div>
<div class="line">../poky/meta-sensors$ mkdir recipes-sensor-simu/sensor-simu/files</div>
<div class="line">../poky/meta-sensors$ cp $BUILD_SENSOR_SIMU<span class="comment">/*.* recipes-sensor-stats/sensor-simu/files/</span></div>
<div class="line"><span class="comment">...poky/meta-sensors$ tree recipes-sensor-simu/ -L 3</span></div>
<div class="line"><span class="comment">recipes-sensor-simu/</span></div>
<div class="line"><span class="comment">└── sensor-simu</span></div>
<div class="line"><span class="comment">    ├── files</span></div>
<div class="line"><span class="comment">    │   ├── README.h</span></div>
<div class="line"><span class="comment">    │   ├── TODO.h</span></div>
<div class="line"><span class="comment">    │   ├── common.cpp</span></div>
<div class="line"><span class="comment">    │   ├── common.h</span></div>
<div class="line"><span class="comment">    │   ├── main.cpp</span></div>
<div class="line"><span class="comment">    │   ├── mainwindow.cpp</span></div>
<div class="line"><span class="comment">    │   ├── mainwindow.h</span></div>
<div class="line"><span class="comment">    │   ├── mainwindow.ui</span></div>
<div class="line"><span class="comment">    │   ├── sensor_simu.pro</span></div>
<div class="line"><span class="comment">    └── sensor-stats_0.1.bb</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">2 directories, 14 files</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">../poky/buils$ bitbake-layers add-layer ../meta-sensors</span></div>
</div><!-- fragment --><p>We will edit our recipe sensor-stats_0.1.bb as follow :</p>
<div class="fragment"><div class="line">SUMMARY = <span class="stringliteral">&quot;My Sensor Simu application&quot;</span></div>
<div class="line">LICENSE = <span class="stringliteral">&quot;CLOSED&quot;</span></div>
<div class="line">PR = <span class="stringliteral">&quot;1&quot;</span></div>
<div class="line"> </div>
<div class="line">SRC_URI = <span class="stringliteral">&quot;file://common.cpp \</span></div>
<div class="line"><span class="stringliteral">           file://common.h \</span></div>
<div class="line"><span class="stringliteral">           file://main.cpp \</span></div>
<div class="line"><span class="stringliteral">           file://mainwindow.ui \</span></div>
<div class="line"><span class="stringliteral">           file://mainwindow.cpp \</span></div>
<div class="line"><span class="stringliteral">           file://mainwindow.h \</span></div>
<div class="line"><span class="stringliteral">           file://sensor_simu.pro \&quot;</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">S = &quot;</span>${WORKDIR}<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">require recipes-qt/qt5/qt5.inc</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">DEPENDS += &quot;</span>qtbase<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">inherit qmake5</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">#COMPILE MYIN THE DATADIR OF THE IMAGE,</span></div>
<div class="line"><span class="stringliteral">do_install() {</span></div>
<div class="line"><span class="stringliteral">    install -d ${D}${datadir}/${P}</span></div>
<div class="line"><span class="stringliteral">    install -m 0755 ${S}/sensor-stats ${D}${datadir}/${P}</span></div>
<div class="line"><span class="stringliteral">    cp -R --no-dereference --preserve=mode,links ${S} ${D}${datadir}/${P}</span></div>
<div class="line"><span class="stringliteral">}</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">FILES_${PN} += &quot;</span>${datadir}<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">RDEPENDS_${PN} = &quot;</span>qtbase qtcore<span class="stringliteral">&quot;</span></div>
</div><!-- fragment --><p>For the other recipes, we will follow the same process, to obtain the following architecture</p>
<div class="fragment"><div class="line">...poky$ tree meta-sensors/ -L 4</div>
<div class="line">meta-sensors/</div>
<div class="line">├── COPYING.MIT</div>
<div class="line">├── README</div>
<div class="line">├── conf</div>
<div class="line">│   └── layer.conf</div>
<div class="line">├── recipes-sensor-alerts</div>
<div class="line">│   └── sensor-alerts</div>
<div class="line">│       ├── files</div>
<div class="line">│       └── sensor-alerts_0.1.bb</div>
<div class="line">├── recipes-sensor-simu</div>
<div class="line">│   └── sensor-simu</div>
<div class="line">│       └── sensor-simu_0.1.bb</div>
<div class="line">└── recipes-sensor-stats</div>
<div class="line">    └── sensor-stats</div>
<div class="line">        └── sensor-stats_0.1.bb</div>
</div><!-- fragment --><p>In our build local.conf, we will need to add some options in order to build images. But still trying to find the correct conf honestly, for now I have add this settings and have Qt5everywheredemo running, but using cmake to compile and using QML instead of ui</p>
<div class="fragment"><div class="line"><span class="preprocessor">##services systemd</span></div>
<div class="line"> </div>
<div class="line">DISTRO_FEATURES:append = <span class="stringliteral">&quot; systemd&quot;</span></div>
<div class="line">DISTRO_FEATURES:BACKFILL_CONSIDERED += <span class="stringliteral">&quot;sysvinit&quot;</span></div>
<div class="line">VIRTUAL-RUNTIME:init_manager = <span class="stringliteral">&quot;systemd&quot;</span></div>
<div class="line">VIRTUAL-RUNTIME:initscripts = <span class="stringliteral">&quot;systemd-compat-units&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">##Default distro</span></div>
<div class="line">DISTRO ?= <span class="stringliteral">&quot;poky&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">## Trying to compile on host if possible </span></div>
<div class="line">IMAGE_FEATURES += <span class="stringliteral">&quot; tools-sdk tools-debug eclipse-debug dev-pkgs &quot;</span></div>
<div class="line">EXTRA_IMAGE_FEATURES ?= <span class="stringliteral">&quot;debug-tweaks tools-sdk dev-pkgs&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">## Adding Qt lib, projects, and qt5everywhere runs on target, but it uses QML, not ui</span></div>
<div class="line">IMAGE_INSTALL:append = <span class="stringliteral">&quot; nano qtbase qtbase-tools qtdeclarative qt5everywheredemo&quot;</span></div>
<div class="line">DISTRO_FEATURES:append = <span class="stringliteral">&quot; qt5&quot;</span></div>
<div class="line">PACKAGECONFIG:append_pn-qtbase = <span class="stringliteral">&quot; icu&quot;</span></div>
<div class="line">PACKAGECONFIG:append:pn-qemu-system-native = <span class="stringliteral">&quot; gtk+&quot;</span></div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
